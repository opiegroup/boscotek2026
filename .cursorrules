# Boscotek Configurator - AI Coding Rules

## IFC Export Guidelines (Full Specification - LOD 200-300)

When working with IFC (Industry Foundation Classes) export code, follow the complete specification:

### Section 1: Critical Rules (No Floats)

1. **NEVER pass null/float for IfcProject.RepresentationContexts**
   - Must be a LIST of IfcGeometricRepresentationContext entities
   - Example: `[geometricContext]` NOT `null` or `0.0`

2. **NEVER pass null/float for IfcProject.UnitsInContext**
   - Must be an IfcUnitAssignment entity reference
   - Example: `unitAssignment` NOT `null` or `1.0`

3. **ALWAYS create complete spatial hierarchy**
   - Required: IfcProject → IfcSite → IfcBuilding → IfcBuildingStorey → Products
   - NEVER skip IfcBuildingStorey
   - NEVER place products directly in IfcBuilding

4. **ObjectPlacement must ALWAYS be an entity**
   - Use IfcLocalPlacement, NEVER a float or primitive
   - Example: `productLocalPlacement` NOT `0.0`

5. **Relationship attributes must be entity references**
   - RelatingObject, RelatedObjects → entity references
   - RelatingStructure, RelatedElements → entity references
   - NEVER floats or primitives

### Section 2: Units (Millimeters)

```typescript
// CORRECT - Use millimeters as per specification
const lengthUnit = createEntity('IFCSIUNIT', '*', 'LENGTHUNIT', '.MILLI.', 'METRE');

// Convert all dimensions to millimeters
const dimensions = {
  width: dimensionsMeters.width * 1000,
  height: dimensionsMeters.height * 1000,
  depth: dimensionsMeters.depth * 1000
};
```

### Section 3: IFC Header

```typescript
// Include CoordinationView4 and Opie Manufacturing Group
FILE_DESCRIPTION(('ViewDefinition [CoordinationView4]'), '2;1');
FILE_NAME('...', '...', ('Boscotek Configurator'), ('Opie Manufacturing Group'), ...);
```

### Section 4: Product Type Mapping

```typescript
// Set ObjectType to full Boscotek configuration code
const productInstance = createEntity(
  'IFCFURNISHINGELEMENT',
  referenceCode,                    // GlobalId
  ownerHistoryId,
  product.name,                     // Name
  product.description,              // Description
  referenceCode,                    // ObjectType (FULL CODE: BTCS.700.560...)
  productLocalPlacement,
  bodyRepresentation,
  null
);
```

### Section 5: Property Sets (Pset_BoscotekCabinet)

Always include these properties:
- ✅ BoscotekCode (IfcIdentifier)
- ✅ Family (IfcLabel)
- ✅ Manufacturer: "Boscotek"
- ✅ OwnerOrganisation: "Opie Manufacturing Group"
- ✅ Width, Depth, Height (IfcLengthMeasure in mm)
- ✅ NumberOfDrawers (IfcInteger)
- ✅ DrawerConfigurationCode (IfcLabel)
- ✅ UDLDrawerCapacity, UDLCabinetCapacity (IfcLabel)
- ✅ MaterialBody, MaterialFronts (IfcLabel)
- ✅ FinishBody, FinishFronts (IfcLabel with descriptive names)
- ✅ BasePrice, TotalPrice (IfcMonetaryMeasure)
- ✅ URLProductPage (IfcText)

### Section 6: Assembly (Drawers)

```typescript
// Drawers must be aggregated under cabinet using IfcRelAggregates
const drawerIds = addDrawerGeometry(...);
if (drawerIds.length > 0) {
  createEntity('IFCRELAGGREGATES', 
    'CabinetDrawerAssembly', 
    ownerHistoryId, 
    'Cabinet with Drawers', 
    null, 
    productInstance,  // Parent (cabinet)
    drawerIds         // Children (drawers)
  );
}
```

### Section 7: Creation Order

1. OwnerHistory
2. Units (with .MILLI. prefix)
3. Geometric Context
4. Project (with contexts and units)
5. Site, Building, Storey
6. Aggregation relationships (Project→Site→Building→Storey)
7. Products
8. Spatial containment (Products→Storey)
9. Property sets
10. Assemblies (Cabinet→Drawers)

### IFC Entity Reference Rules

```typescript
// ✅ CORRECT - Entity reference
const project = createEntity('IFCPROJECT', ..., [contextId], unitAssignmentId);

// ❌ WRONG - Null or float value
const project = createEntity('IFCPROJECT', ..., null, null);
const project = createEntity('IFCPROJECT', ..., 0.0, 1.0);

// ✅ CORRECT - Coordinate list
const point = createEntity('IFCCARTESIANPOINT', [0., 0., 0.]);

// ❌ WRONG - Entity references where coordinates expected
const point = createEntity('IFCCARTESIANPOINT', [#10, #11, #12]);
```

### Spatial Structure Template

When creating IFC spatial hierarchy, always use this pattern:

```typescript
// 1. Create units and contexts FIRST
const units = createEntity('IFCUNITASSIGNMENT', ...);
const context = createEntity('IFCGEOMETRICREPRESENTATIONCONTEXT', ...);

// 2. Create project WITH references
const project = createEntity('IFCPROJECT', ..., [context], units);

// 3. Create COMPLETE spatial hierarchy
const site = createEntity('IFCSITE', ...);
const building = createEntity('IFCBUILDING', ...);
const storey = createEntity('IFCBUILDINGSTOREY', ...);  // DON'T SKIP THIS!

// 4. Create aggregation relationships
createEntity('IFCRELAGGREGATES', ..., project, [site]);
createEntity('IFCRELAGGREGATES', ..., site, [building]);
createEntity('IFCRELAGGREGATES', ..., building, [storey]);

// 5. Place products in STOREY (not building)
createEntity('IFCRELCONTAINEDINSPATIALSTRUCTURE', ..., [product], storey);
```

### Validation Before Deployment

Before deploying IFC export code, verify:

- [ ] IfcProject has RepresentationContexts (not null)
- [ ] IfcProject has UnitsInContext (not null)
- [ ] IfcBuildingStorey exists in hierarchy
- [ ] Products are contained in BuildingStorey
- [ ] All entity references use # notation
- [ ] All coordinates are float arrays

### Testing Requirements

When modifying IFC export:

1. Generate test IFC file
2. Open in BlenderBIM (must load without errors)
3. Verify spatial hierarchy: Project → Site → Building → Storey → Products
4. Verify 3D geometry is visible
5. Check for error: "AttributeError: 'float' object has no attribute 'is_a'"

### Reference Documentation

For IFC export work, consult:
- `IFC_EXPORTER_TEMPLATE.md` - Complete implementation guide
- `IFC_SCHEMA_COMPLIANCE_CHECKLIST.md` - Validation checklist
- `IFC_EXPORT_FIX_SUMMARY.md` - Common issues and fixes

## General TypeScript Guidelines

- Use explicit types for all function parameters
- Avoid `any` type when possible
- Use descriptive variable names (e.g., `geometricContext` not `ctx`)
- Add comments for complex IFC entity relationships

## Supabase Edge Functions

- Always handle CORS preflight requests
- Use environment variables for sensitive keys
- Include proper error handling with try/catch
- Return structured JSON responses
- Log errors to console for debugging

## React/TypeScript Frontend

- Use functional components with hooks
- Keep components focused and single-responsibility
- Extract complex logic to services/utils
- Use TypeScript interfaces for props
- Handle loading and error states

## Naming Conventions

- Files: `kebab-case.ts` or `PascalCase.tsx` (React components)
- Variables: `camelCase`
- Constants: `UPPER_SNAKE_CASE`
- Types/Interfaces: `PascalCase`
- IFC entities: Match IFC schema exactly (e.g., `IFCPROJECT`, `IFCSITE`)
